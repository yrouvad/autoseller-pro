class AutoSellerPro {
    constructor() {
        this.currentImage = null;
        this.generatedListings = {};
        this.platformFees = {
            vinted: 0,
            pinterest: 0,
            etsy: 0.065,
            leboncoin: 0,
            ebay: 0.129
        };
        
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.setupTabs();
        this.setupDragAndDrop();
    }

    setupEventListeners() {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('productImage');
        const removeImageBtn = document.getElementById('removeImage');

        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => this.handleImageUpload(e));
        removeImageBtn.addEventListener('click', () => this.removeImage());

        document.getElementById('aliPrice').addEventListener('input', () => this.calculatePrices());
        document.getElementById('marginCoef').addEventListener('change', () => this.calculatePrices());

        document.getElementById('generateBtn').addEventListener('click', () => this.generateListings());
        document.getElementById('publishBtn').addEventListener('click', () => this.publishListings());

        document.getElementById('productName').addEventListener('input', () => this.updatePreview());
        document.getElementById('category').addEventListener('change', () => this.updatePreview());
        document.getElementById('keyPoints').addEventListener('input', () => this.updatePreview());
    }

    setupTabs() {
        const tabBtns = document.querySelectorAll('.tab-btn');
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                
                tabBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                document.querySelectorAll('.preview-card').forEach(card => {
                    card.classList.remove('active');
                });
                document.getElementById(`${tabName}-preview`).classList.add('active');
            });
        });
    }

    setupDragAndDrop() {
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                this.processImage(files[0]);
            }
        });
    }

    handleImageUpload(event) {
        const file = event.target.files[0];
        if (file) {
            this.processImage(file);
        }
    }

    processImage(file) {
        if (!file.type.startsWith('image/')) {
            alert('Veuillez s√©lectionner une image valide.');
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            this.currentImage = e.target.result;
            this.displayImage();
        };
        reader.readAsDataURL(file);
    }

    displayImage() {
        const uploadArea = document.getElementById('uploadArea');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');

        uploadArea.style.display = 'none';
        imagePreview.style.display = 'block';
        previewImg.src = this.currentImage;
    }

    removeImage() {
        this.currentImage = null;
        document.getElementById('uploadArea').style.display = 'block';
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('productImage').value = '';
    }

    calculatePrices() {
        const aliPrice = parseFloat(document.getElementById('aliPrice').value) || 0;
        const marginCoef = parseFloat(document.getElementById('marginCoef').value) || 2.0;

        if (aliPrice <= 0) {
            this.resetPrices();
            return;
        }

        const platforms = ['vinted', 'pinterest', 'etsy', 'leboncoin', 'ebay'];
        
        platforms.forEach(platform => {
            const basePrice = aliPrice * marginCoef;
            const fees = basePrice * this.platformFees[platform];
            const finalPrice = basePrice + fees;
            const psychologicalPrice = this.applyPsychologicalPricing(finalPrice);
            
            document.getElementById(`${platform}Price`).textContent = `${psychologicalPrice.toFixed(2)} ‚Ç¨`;
        });
    }

    applyPsychologicalPricing(price) {
        const cents = price % 1;
        const whole = Math.floor(price);
        
        if (cents < 0.5) {
            return whole + 0.99;
        } else {
            return whole + 0.95;
        }
    }

    resetPrices() {
        const platforms = ['vinted', 'pinterest', 'etsy', 'leboncoin', 'ebay'];
        platforms.forEach(platform => {
            document.getElementById(`${platform}Price`).textContent = '--';
        });
    }

    async generateListings() {
        const productName = document.getElementById('productName').value;
        const category = document.getElementById('category').value;
        const keyPoints = document.getElementById('keyPoints').value;
        const aliPrice = parseFloat(document.getElementById('aliPrice').value) || 0;

        if (!this.currentImage || !productName || !category || aliPrice <= 0) {
            alert('Veuillez remplir tous les champs requis et t√©l√©charger une image.');
            return;
        }

        this.showLoading(true);

        try {
            await this.simulateGeneration(productName, category, keyPoints, aliPrice);
            this.updatePreview();
            document.getElementById('publishBtn').disabled = false;
        } catch (error) {
            console.error('Erreur lors de la g√©n√©ration:', error);
            alert('Erreur lors de la g√©n√©ration des annonces.');
        } finally {
            this.showLoading(false);
        }
    }

    async simulateGeneration(productName, category, keyPoints, aliPrice) {
        await new Promise(resolve => setTimeout(resolve, 2000));

        const marginCoef = parseFloat(document.getElementById('marginCoef').value) || 2.0;
        const basePrice = aliPrice * marginCoef;

        this.generatedListings = {
            vinted: {
                title: this.generateVintedTitle(productName, category),
                description: this.generateVintedDescription(productName, category, keyPoints),
                price: this.applyPsychologicalPricing(basePrice)
            },
            pinterest: {
                title: this.generatePinterestTitle(productName, category),
                description: this.generatePinterestDescription(productName, category, keyPoints)
            },
            etsy: {
                title: this.generateEtsyTitle(productName, category),
                description: this.generateEtsyDescription(productName, category, keyPoints),
                price: this.applyPsychologicalPricing(basePrice + (basePrice * this.platformFees.etsy))
            },
            leboncoin: {
                title: this.generateLeboncoinTitle(productName, category),
                description: this.generateLeboncoinDescription(productName, category, keyPoints),
                price: this.applyPsychologicalPricing(basePrice)
            },
            ebay: {
                title: this.generateEbayTitle(productName, category),
                description: this.generateEbayDescription(productName, category, keyPoints),
                price: this.applyPsychologicalPricing(basePrice + (basePrice * this.platformFees.ebay))
            }
        };
    }

    generateVintedTitle(productName, category) {
        const prefixes = ['Neuf', 'Magnifique', 'Superbe', '√âl√©gant'];
        const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
        return `${prefix} ${productName} - ${this.getCategoryName(category)}`;
    }

    generateVintedDescription(productName, category, keyPoints) {
        return `‚ú® ${productName} en parfait √©tat !

üéØ Description :
${keyPoints}

üìè Taille : Taille unique
üé® Couleur : Comme sur les photos
üì¶ √âtat : Neuf avec √©tiquette

üíù Parfait pour :
- Les amateurs de ${category}
- Un cadeau original
- Un usage quotidien

üì¨ Envoi rapide et soign√©
ü§ù Possibilit√© de remise en main propre

N'h√©sitez pas √† me contacter pour plus d'informations !`;
    }

    generatePinterestTitle(productName, category) {
        return `${productName} - Id√©e ${category} tendance 2024`;
    }

    generatePinterestDescription(productName, category, keyPoints) {
        return `D√©couvrez ce magnifique ${productName} ! 

üí° Id√©e parfaite pour votre collection ${category}

‚ú® Caract√©ristiques :
${keyPoints}

üí´ Style moderne et tendance
üåø Mat√©riaux de qualit√©
üìè Dimensions parfaites

#${category} #tendance2024 #shopping #id√©e`;
    }

    generateEtsyTitle(productName, category) {
        return `${productName} | ${this.getCategoryName(category)} | Cadeau parfait`;
    }

    generateEtsyDescription(productName, category, keyPoints) {
        return `Bienvenue dans ma boutique !

üéÅ ${productName} - Un article unique pour votre collection

üìã D√©tails du produit :
${keyPoints}

‚ú® Pourquoi nous choisir ?
- Qualit√© exceptionnelle
- Service client r√©actif
- Emballage soign√©
- Livraison rapide

üéÄ Id√©al comme cadeau pour :
- Anniversaire
- No√´l
- F√™te des m√®res
- Ou simplement pour se faire plaisir

üì¶ Informations d'exp√©dition :
- Pr√©paration : 1-2 jours ouvr√©s
- Livraison : 3-5 jours ouvr√©s

Des questions ? N'h√©sitez pas √† me contacter !`;
    }

    generateLeboncoinTitle(productName, category) {
        return `${productName} - Neuf`;
    }

    generateLeboncoinDescription(productName, category, keyPoints) {
        return `Vends ${productName} neuf.

${keyPoints}

Prix ferme. Remise en main propre possible.
Premier arriv√©, premier servi !`;
    }

    generateEbayTitle(productName, category) {
        return `${productName} NEW ${this.getCategoryName(category)} FAST SHIPPING`;
    }

    generateEbayDescription(productName, category, keyPoints) {
        return `NEW ${productName}

FEATURES:
${keyPoints}

CONDITION: Brand new with tags
SHIPPING: Fast and secure
RETURNS: 30-day return policy

Buy with confidence!`;
    }

    getCategoryName(category) {
        const names = {
            fashion: 'Mode',
            home: 'Maison',
            tech: 'Technologie',
            beauty: 'Beaut√©',
            toys: 'Jouets'
        };
        return names[category] || 'Produit';
    }

    updatePreview() {
        if (!this.generatedListings.vinted) return;

        Object.keys(this.generatedListings).forEach(platform => {
            const listing = this.generatedListings[platform];
            
            if (listing.title) {
                document.getElementById(`${platform}Title`).textContent = listing.title;
            }
            
            if (listing.description) {
                document.getElementById(`${platform}Desc`).textContent = listing.description;
            }
            
            if (listing.price) {
                document.getElementById(`${platform}PricePreview`).textContent = `${listing.price.toFixed(2)} ‚Ç¨`;
            }
        });
    }

    async publishListings() {
        const selectedPlatforms = Array.from(document.querySelectorAll('.platform-item input[type="checkbox"]:checked'))
            .map(cb => cb.value);

        if (selectedPlatforms.length === 0) {
            alert('Veuillez s√©lectionner au moins une plateforme.');
            return;
        }

        this.showLoading(true);

        try {
            await this.simulatePublishing(selectedPlatforms);
            alert(`‚úÖ Annonces publi√©es avec succ√®s sur : ${selectedPlatforms.join(', ')}`);
        } catch (error) {
            console.error('Erreur lors de la publication:', error);
            alert('Erreur lors de la publication des annonces.');
        } finally {
            this.showLoading(false);
        }
    }

    async simulatePublishing(platforms) {
        await new Promise(resolve => setTimeout(resolve, 3000));
        console.log('Publication simul√©e sur:', platforms);
    }

    showLoading(show) {
        const overlay = document.getElementById('loadingOverlay');
        overlay.style.display = show ? 'flex' : 'none';
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new AutoSellerPro();
});
